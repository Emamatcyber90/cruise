all: lib/libscrmfs-posix.a

DESTDIR =
srcdir = @srcdir@
prefix = @prefix@
exec_prefix = @exec_prefix@
datarootdir = $(DESTDIR)@datarootdir@
includedir = $(DESTDIR)@includedir@
mandir = $(DESTDIR)@mandir@
sbindir = $(DESTDIR)@sbindir@
bindir = $(DESTDIR)@bindir@
libdir = $(DESTDIR)@libdir@
LDFLAGS = @LDFLAGS@
CC = @CC@
LD = @LD@

CONTAINER_HOME = ./container
CONTAINER_INCS = -I$(CONTAINER_HOME)/include
CONTAINER_LDFLAGS = -L$(CONTAINER_HOME)/lib
CONTAINER_LIBS = #-lcontainer
#CONTAINER_LIBNAME = $(CONTAINER_HOME)/lib/libcontainer.a

NUMA_HOME = ./numactl
NUMA_INCS = -I$(NUMA_HOME)
NUMA_LIBS = -lnuma


DISABLE_LDPRELOAD = @DISABLE_LDPRELOAD@
SCRMFS_LOG_FORMAT = $(srcdir)/../scrmfs-log-format.h

ifndef DISABLE_LDPRELOAD
all: lib/libscrmfs.so 
endif

VPATH = $(srcdir)

CFLAGS = -DSCRMFS_CONFIG_H=\"scrmfs-runtime-config.h\" -I . -I ../ -I $(srcdir) -I$(srcdir)/../ $(NUMA_INCS) @CFLAGS@ @CPPFLAGS@ -D_LARGEFILE64_SOURCE 

CFLAGS_SHARED = -DSCRMFS_CONFIG_H=\"scrmfs-runtime-config.h\" -I . -I$(srcdir) -I$(srcdir)/../ $(NUMA_INCS) @CFLAGS@ @CPPFLAGS@ -D_LARGEFILE64_SOURCE -shared -fpic -DPIC -DSCRMFS_PRELOAD

LIBS = -lz @LIBBZ2@ $(NUMA_LIBS)

lib::
	@mkdir -p $@

#lib/scrmfs-mpi-io.o: lib/scrmfs-mpi-io.c scrmfs.h scrmfs-dynamic.h $(SCRMFS_LOG_FORMAT) | lib
#	$(CC) $(CFLAGS) -c $< -o $@

#lib/scrmfs-mpi-io.po: lib/scrmfs-mpi-io.c scrmfs.h scrmfs-dynamic.h $(SCRMFS_LOG_FORMAT) | lib
#	$(CC) $(CFLAGS_SHARED) -c $< -o $@

#lib/scrmfs-mpi-init-finalize.o: lib/scrmfs-mpi-init-finalize.c scrmfs.h scrmfs-dynamic.h $(SCRMFS_LOG_FORMAT) | lib
#	$(CC) $(CFLAGS) -c $< -o $@

#lib/scrmfs-mpi-init-finalize.po: lib/scrmfs-mpi-init-finalize.c scrmfs.h scrmfs-dynamic.h $(SCRMFS_LOG_FORMAT) | lib
#	$(CC) $(CFLAGS_SHARED) -c $< -o $@

lib/scrmfs-container.o: lib/scrmfs-container.c
	$(CC) $(CFLAGS) $(CONTAINER_INCS) -c $< -o $@

lib/scrmfs-container.po: lib/scrmfs-container.c
	$(CC) $(CFLAGS_SHARED) $(CONTAINER_INCS) -c $< -o $@

#lib/scrmfs-posix.o: lib/scrmfs-posix.c scrmfs.h scrmfs-file.h lib/scrmfs-container.c $(SCRMFS_LOG_FORMAT)
lib/scrmfs-posix.o: lib/scrmfs-posix.c lib/scrmfs-container.h scrmfs.h scrmfs-file.h $(SCRMFS_LOG_FORMAT)
	$(CC) $(CFLAGS) $(CONTAINER_INCS) -c lib/scrmfs-posix.c -o $@

lib/scrmfs-posix.po: lib/scrmfs-posix.c scrmfs.h scrmfs-file.h lib/scrmfs-container.c $(SCRMFS_LOG_FORMAT)
	$(CC) $(CFLAGS_SHARED) $(CONTAINER_INCS) -c lib/scrmfs-posix.c -o $@

lib/lookup3.o: lib/lookup3.c
	$(CC) $(CFLAGS) -c $< -o $@

lib/lookup3.po: lib/lookup3.c
	$(CC) $(CFLAGS_SHARED) -c $< -o $@

lib/lookup8.o: lib/lookup8.c
	$(CC) $(CFLAGS) -c $< -o $@

lib/lookup8.po: lib/lookup8.c
	$(CC) $(CFLAGS_SHARED) -c $< -o $@

scrmfs-stack.o: scrmfs-stack.c scrmfs-stack.h
	$(CC) $(CFLAGS) -c $< -o $@

scrmfs-stack.po: scrmfs-stack.c scrmfs-stack.h
	$(CC) $(CFLAGS_SHARED) -c $< -o $@


%.i: %.c
	$(CC) -E $(CFLAGS) -c $< -o $@

#lib/libscrmfs-mpi-io.a: lib/scrmfs-mpi-io.o lib/scrmfs-mpi-init-finalize.o
#	ar rcs $@ $^

lib/libscrmfs-posix.a: lib/scrmfs-posix.o lib/lookup3.o lib/lookup8.o lib/scrmfs-container.o scrmfs-stack.o 
	ar rcs $@ $^

#lib/libscrmfs.so: lib/scrmfs-mpi-io.po lib/scrmfs-mpi-init-finalize.po lib/scrmfs-posix.po lib/lookup3.po lib/lookup8.po scrmfs-stack.po
lib/libscrmfs.so: lib/scrmfs-posix.po lib/lookup3.po lib/lookup8.po lib/scrmfs-container.po scrmfs-stack.po
	$(CC) $(CFLAGS_SHARED) $(LDFLAGS) $(CONTAINER_LDFLAGS) -ldl -o $@ $^ -lpthread -lrt -lz $(CONTAINER_LIBS)

install:: all
	install -d $(libdir)
	install -m 755 lib/libscrmfs-posix.a $(libdir)
#	install -m 755 lib/libscrmfs-mpi-io.a $(libdir)
ifndef DISABLE_LDPRELOAD
	install -m 755 lib/libscrmfs.so $(libdir)
endif
	install -d $(bindir)
	install -m 755 scrmfs-gen-cc.pl $(bindir)
	install -m 755 scrmfs-gen-cxx.pl $(bindir)
	install -m 755 scrmfs-gen-fortran.pl $(bindir)
	install -m 755 scrmfs-config $(bindir)

clean::
	rm -f *.o *.po *.a lib/*.o lib/*.po lib/*.a lib/*.so 

distclean:: clean
	rm -f scrmfs-runtime-config.h scrmfs-gen-cxx.pl scrmfs-gen-fortran.pl scrmfs-gen-cc.pl scrmfs-mk-log-dirs.pl aclocal.m4 autom4te.cache/* config.status config.log Makefile 
	rm -rf autom4te.cache
